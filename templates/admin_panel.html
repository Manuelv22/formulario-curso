{% extends "layout.html" %}

{% block content %}
<h2>Panel de administración — Inscripciones</h2>
<div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>ID</th>
        <th>Teléfono</th>
        <th>Email</th>
        <th>Experiencia</th>
        <th>Mensaje</th>
        <th>Creado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r[0] }}</td>
        <td>{{ r[1] }}</td>
        <td>{{ r[2] }}</td>
        <td>{{ r[3] }}</td>
        <td>{{ r[4] }}</td>
        <td>{{ r[6] }}</td>
        <td>{{ r[7] }}</td>
        <td>{{ r[8] }}</td>
        <td>{{ r[9] }}</td>
        <td>
          <a class="btn btn-sm btn-outline-primary" href="/admin/edit/{{ r[0] }}">Editar</a>
          <form action="/admin/delete/{{ r[0] }}" method="post" style="display:inline-block;margin-left:.25rem;">
            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminar este registro?');">Eliminar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="d-flex gap-2">
  <a class="btn btn-secondary" href="/admin/logout">Cerrar sesión</a>
  <a class="btn btn-outline-success" href="/admin/export">Exportar CSV</a>
</div>
<!-- Edit Modal -->
<div class="modal fade" id="adminEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar inscripción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="adminEditBody">
        <!-- form injected via JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="adminSaveBtn" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Admin AJAX: Edit and Delete without page reload
document.addEventListener('DOMContentLoaded', function(){
  const editModal = new bootstrap.Modal(document.getElementById('adminEditModal'));
  let currentEditId = null;

  document.querySelectorAll('a[href^="/admin/edit/"]').forEach(function(a){
    a.addEventListener('click', function(ev){
      ev.preventDefault();
      const href = a.getAttribute('href');
      const parts = href.split('/');
      const id = parts[parts.length-1];
      currentEditId = id;
      fetch('/admin/api/row/' + id)
        .then(r => r.json())
        .then(data => {
          const body = document.getElementById('adminEditBody');
          body.innerHTML = `
            <form id="adminEditForm">
              <div class="row g-2">
                <div class="col-md-6"><label class="form-label">Nombre</label><input name="nombre" class="form-control" value="${escapeHtml(data.nombre)}" required></div>
                <div class="col-md-6"><label class="form-label">Apellido</label><input name="apellido" class="form-control" value="${escapeHtml(data.apellido)}" required></div>
                <div class="col-md-6"><label class="form-label">Identificación</label><input name="identificacion" class="form-control" value="${escapeHtml(data.identificacion)}"></div>
                <div class="col-md-6"><label class="form-label">Teléfono</label><input name="telefono" class="form-control" value="${escapeHtml(data.telefono)}" required></div>
                <div class="col-12"><label class="form-label">Dirección</label><input name="direccion" class="form-control" value="${escapeHtml(data.direccion)}"></div>
                <div class="col-md-6"><label class="form-label">Email</label><input name="email" class="form-control" value="${escapeHtml(data.email)}" required></div>
                <div class="col-md-6"><label class="form-label">Experiencia</label><input name="experiencia" class="form-control" value="${escapeHtml(data.experiencia)}"></div>
                <div class="col-12"><label class="form-label">Mensaje</label><textarea name="mensaje" class="form-control">${escapeHtml(data.mensaje)}</textarea></div>
              </div>
            </form>`;
          editModal.show();
        })
    })
  })

  document.getElementById('adminSaveBtn').addEventListener('click', function(){
    const form = document.getElementById('adminEditForm');
    if(!form) return;
    const fd = new FormData(form);
    const obj = {};
    fd.forEach((v,k)=>obj[k]=v);
    fetch('/admin/api/edit/' + currentEditId, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj)
    }).then(r=>r.json()).then(res=>{
      if(res.ok){
        // update row in table
        const row = document.querySelector('tr td:first-child').parentNode; // fallback
        // simple approach: reload page to reflect changes
        location.reload();
      } else {
        alert('Error: ' + (res.error||'No se pudo actualizar'))
      }
    })
  })

  // Delete via fetch for forms with action /admin/delete/<id>
  document.querySelectorAll('form[action^="/admin/delete/"]').forEach(function(f){
    f.addEventListener('submit', function(ev){
      ev.preventDefault();
      if(!confirm('Eliminar este registro?')) return;
      const action = f.getAttribute('action');
      fetch(action, {method:'POST'}).then(r=>{
        if(r.ok){
          // remove row
          f.closest('tr').remove();
        } else {
          alert('Error al eliminar')
        }
      })
    })
  })

  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
});
</script>
{% endblock %}
